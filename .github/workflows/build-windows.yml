name: Windows Build

on:
  workflow_dispatch:  # Manuell ausloesbar ueber GitHub UI
  push:
    tags:
      - "v*"  # Automatisch bei Version-Tags (v1.0, v1.1, ...)

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Abhaengigkeiten installieren
        run: |
          pip install -r requirements.txt
          pip install nuitka ordered-set zstandard Pillow cairosvg

      - name: libmpv herunterladen
        shell: pwsh
        run: |
          # mpv-dev von SourceForge (x86_64)
          $mpvUrl = "https://sourceforge.net/projects/mpv-player-windows/files/libmpv/mpv-dev-x86_64-20240121-git-a39f9b6.7z/download"
          Write-Host "Lade libmpv herunter..."
          Invoke-WebRequest -Uri $mpvUrl -OutFile mpv-dev.7z -UserAgent "wget" -MaximumRetryCount 3
          7z x mpv-dev.7z -ompv-dev -y
          Copy-Item mpv-dev\libmpv-2.dll .
          Write-Host "libmpv-2.dll bereit"

      - name: ffmpeg herunterladen
        shell: pwsh
        run: |
          $ffUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          Write-Host "Lade ffmpeg herunter..."
          Invoke-WebRequest -Uri $ffUrl -OutFile ffmpeg.zip -MaximumRetryCount 3
          Expand-Archive ffmpeg.zip -DestinationPath ffmpeg-tmp
          $ffExe = Get-ChildItem -Path ffmpeg-tmp -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          Write-Host "ffmpeg gefunden: $($ffExe.FullName)"
          Copy-Item $ffExe.FullName ffmpeg-bundled.exe
          Write-Host "ffmpeg bereit"

      - name: EXE bauen
        run: python build_windows.py

      - name: Build-Verzeichnis pruefen
        shell: pwsh
        run: |
          Write-Host "=== Top-Level DLLs ==="
          Get-ChildItem "dist\MF IPTV Player\*.dll" | Format-Table Name, Length
          Write-Host "=== PySide6-Verzeichnis ==="
          if (Test-Path "dist\MF IPTV Player\PySide6") {
            Get-ChildItem "dist\MF IPTV Player\PySide6" -Recurse -Include *.dll,*.pyd | Format-Table FullName, Length
          } else {
            Write-Host "Kein PySide6-Unterordner gefunden"
          }
          Write-Host "=== Qt/shiboken PYD-Dateien ==="
          Get-ChildItem "dist\MF IPTV Player" -Recurse -Include "Qt*.pyd","shiboken*.pyd","shiboken*.dll" | Format-Table FullName, Length
          Write-Host "=== Qt6 Core DLLs ==="
          Get-ChildItem "dist\MF IPTV Player" -Recurse -Include "Qt6Core.dll","Qt6Widgets.dll","Qt6Gui.dll" | Format-Table FullName, Length
          Write-Host "=== Platform Plugins ==="
          Get-ChildItem "dist\MF IPTV Player" -Recurse -Include "qwindows.dll" | Format-Table FullName, Length

      - name: ffmpeg in Build-Ordner kopieren
        shell: pwsh
        run: |
          Copy-Item ffmpeg-bundled.exe "dist\MF IPTV Player\ffmpeg.exe"
          Write-Host "Inhalt des Build-Ordners:"
          Get-ChildItem "dist\MF IPTV Player" | Format-Table Name, Length

      - name: ZIP erstellen
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\MF IPTV Player" -DestinationPath "MF-IPTV-Player-Windows.zip"
          $size = (Get-Item "MF-IPTV-Player-Windows.zip").Length / 1MB
          Write-Host ("ZIP-Groesse: {0:N1} MB" -f $size)

      - name: ZIP als Artifact hochladen
        uses: actions/upload-artifact@v4
        with:
          name: MF-IPTV-Player-Windows
          path: MF-IPTV-Player-Windows.zip

      - name: Release erstellen (bei Tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: MF-IPTV-Player-Windows.zip
          generate_release_notes: true
          body: |
            ## MF IPTV Player ${{ github.ref_name }}

            ### Download
            1. `MF-IPTV-Player-Windows.zip` herunterladen
            2. ZIP entpacken
            3. `MF IPTV Player.exe` starten

            ffmpeg fuer Aufnahmen ist enthalten. Keine Installation noetig.
